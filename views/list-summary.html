<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body {
            padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', sans-serif;
        }
        .summary {
            background: #f4f5f7;
            padding: 12px;
            border-radius: 3px;
            margin-bottom: 15px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .summary-item:last-child {
            margin-bottom: 0;
        }
        .label {
            font-weight: 500;
            color: #5e6c84;
        }
        .value {
            font-weight: 600;
            color: #172b4d;
        }
        .total {
            border-top: 2px solid #dfe1e6;
            padding-top: 8px;
            margin-top: 8px;
            font-size: 16px;
        }
        .total .value {
            color: #0079bf;
        }
        .loading {
            text-align: center;
            color: #5e6c84;
            padding: 20px;
        }
        .card-list {
            margin-top: 15px;
        }
        .card-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #dfe1e6;
            font-size: 13px;
        }
        .card-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }
        .card-cost {
            font-weight: 600;
            color: #172b4d;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">Berechne Kosten...</div>
    <div id="summary" style="display: none;">
        <div class="summary">
            <div class="summary-item">
                <span class="label">Karten mit Kosten:</span>
                <span class="value" id="card-count">0</span>
            </div>
            <div class="summary-item total">
                <span class="label">Gesamtkosten:</span>
                <span class="value" id="total-cost">0.00 €</span>
            </div>
        </div>
        <div class="card-list" id="card-list"></div>
    </div>

    <script>
        const t = TrelloPowerUp.iframe();

        function parseCost(costString) {
            if (!costString) return null;
            const match = costString.match(/([\d.,]+)\s*([€$£¥]?)/);
            if (match) {
                const amount = parseFloat(match[1].replace(',', '.'));
                const currency = match[2] || '€';
                return { amount, currency };
            }
            return null;
        }

        function formatCost(amount, currency) {
            return `${amount.toFixed(2)} ${currency}`;
        }

        // Alle Karten in der Liste abrufen
        t.list('id', 'name')
            .then(function(list) {
                return t.cards('id', 'name');
            })
            .then(function(cards) {
                const promises = cards.map(function(card) {
                    return t.get(card.id, 'shared', 'cost')
                        .then(function(cost) {
                            return {
                                id: card.id,
                                name: card.name,
                                cost: cost
                            };
                        });
                });
                return Promise.all(promises);
            })
            .then(function(cardsWithCosts) {
                // Kosten berechnen
                let totalAmount = 0;
                let currency = '€';
                let cardsWithCostCount = 0;
                const cardListElement = document.getElementById('card-list');

                cardsWithCosts.forEach(function(card) {
                    if (card.cost) {
                        const parsed = parseCost(card.cost);
                        if (parsed) {
                            totalAmount += parsed.amount;
                            currency = parsed.currency; // Nimm die Währung der letzten Karte
                            cardsWithCostCount++;

                            // Karte zur Liste hinzufügen
                            const cardItem = document.createElement('div');
                            cardItem.className = 'card-item';
                            cardItem.innerHTML = `
                                <span class="card-name" title="${card.name}">${card.name}</span>
                                <span class="card-cost">${formatCost(parsed.amount, parsed.currency)}</span>
                            `;
                            cardListElement.appendChild(cardItem);
                        }
                    }
                });

                // Anzeige aktualisieren
                document.getElementById('card-count').textContent = cardsWithCostCount;
                document.getElementById('total-cost').textContent = formatCost(totalAmount, currency);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('summary').style.display = 'block';

                // Popup-Höhe anpassen
                const height = Math.min(400, 150 + (cardsWithCostCount * 35));
                t.sizeTo('#summary').then(function() {
                    // Optional: Größe manuell setzen
                });
            })
            .catch(function(error) {
                console.error('Fehler beim Laden der Kosten:', error);
                document.getElementById('loading').textContent = 'Fehler beim Laden der Daten';
            });
    </script>
</body>
</html>
